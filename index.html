<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minha Biblioteca</title>
<style>
  :root{
    --bg:#0b1210; --card:#101a17; --muted:#95b5a3; --text:#e9f4ee;
    --brand:#36c077; --brand-2:#2aa866; --brand-3:#1c7b4b;
    --chip:#183126; --border:#254236; --danger:#ff6b6b;
    --shadow:0 10px 30px rgba(0,0,0,.35); --focus:0 0 0 3px rgba(54,192,119,.35);
  }
  /* Reset + aparÃªncia consistente */
  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:linear-gradient(120deg,#07100c,#0d1513 30%,#07100c);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  img{display:block;max-width:100%}
  button,input{font:inherit;color:inherit}
  button{appearance:none;background:transparent;border:none}
  input{appearance:none;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;outline:none}
  input::placeholder{color:#a8c7b8}
  :focus-visible{outline:none;box-shadow:var(--focus)}
  a{color:var(--brand);text-decoration:none}

  header{position:sticky;top:0;z-index:5;background:rgba(11,18,16,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.3px}
  .pill{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:999px}

  .btn{cursor:pointer;border-radius:10px;background:var(--brand);color:#052313;
       font-weight:700;padding:10px 14px;box-shadow:var(--shadow);
       transition:transform .06s ease,filter .2s}
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .small{padding:7px 10px;font-size:13px;border-radius:8px}

  /* Busca: input + botÃ£o (sem seletor de idioma) */
  .search{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:14px}

  main{padding:22px}
  /* 6 por linha no desktop; responsivo para telas menores */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(6,1fr)}
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(5,1fr);} }
  @media (max-width:992px){ .grid{grid-template-columns:repeat(4,1fr);} }
  @media (max-width:768px){ .grid{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:560px){ .grid{grid-template-columns:repeat(2,1fr);} }

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .thumb{aspect-ratio:3/4;background:#0e1915;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .content{padding:10px}
  .title{font-size:14px;font-weight:700;line-height:1.25;margin:0 0 6px}
  .meta{font-size:12px;color:var(--muted)}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .badge{font-size:10px;background:var(--chip);color:var(--muted);border:1px solid var(--border);padding:3px 6px;border-radius:999px}
  .actions{display:flex;gap:8px;margin-top:auto;padding:10px}

  /* Modal */
  dialog{border:none;border-radius:16px;width:min(900px,96vw);background:linear-gradient(180deg,#0f1a17,#0a1412);color:var(--text);box-shadow:0 30px 80px rgba(0,0,0,.6);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
  .modal{display:grid;grid-template-columns:180px 1fr;gap:18px;padding:18px;border-bottom:1px solid var(--border)}
  .modal .cover{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#0e1915}
  .modal h2{margin:0 0 6px;font-size:20px}
  .modal .sub{color:var(--muted);font-size:13px}
  .scroll{max-height:46vh;overflow:auto;padding:18px;border-top:1px solid var(--border)}
  .lists{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip-btn{border:1px solid var(--border);background:var(--chip);color:var(--muted);padding:8px 10px;border-radius:999px;cursor:pointer}
  .chip-btn.active{background:var(--brand);color:#052313;border-color:transparent}

  /* Rating */
  .rating{display:inline-flex;flex-direction:row-reverse;gap:6px}
  .star{font-size:24px;cursor:pointer;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  .star::before{content:"â˜†"}
  .star.filled::before{content:"â˜…";color:var(--brand)}

  /* SeÃ§Ãµes */
  .section-title{display:flex;align-items:center;gap:10px;margin:0 0 12px;font-size:18px}
  .section-head{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-top:22px}
  .result-meta{color:var(--muted);font-size:13px}

  /* PaginaÃ§Ã£o */
  .pagination{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:18px 0}
  .page-btn{cursor:pointer;border-radius:10px;background:var(--chip);color:var(--muted);padding:8px 12px;border:1px solid var(--border);transition:filter .2s}
  .page-btn:hover{filter:brightness(1.05)}
  .page-btn[disabled]{opacity:.45;cursor:not-allowed;filter:none}
  .page-btn.current{background:var(--brand);color:#052313;border-color:transparent}
  .page-ellipsis{color:var(--muted);padding:8px 6px}

  footer{border-top:1px solid var(--border);padding:18px;color:var(--muted)}
  .empty{opacity:.8;border:1px dashed var(--border);border-radius:14px;padding:20px;text-align:center}
  .error{color:#ffaaaa}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>Minha Biblioteca</h1>
    <span class="pill">Google Books</span>
    <div class="row" style="margin-left:auto">
      <a class="btn btn-ghost" href="listas.html">Ver Listas</a>
      <button class="btn" id="randomBtn" type="button">AleatÃ³rio</button>
    </div>
    <div class="search" style="width:100%">
      <input id="q" type="text" placeholder="Busque por tÃ­tulo, autor ou ISBN..." />
      <button class="btn" id="searchBtn" type="button">Buscar</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- TendÃªncias (com paginaÃ§Ã£o) -->
  <section id="trendingSection">
    <div class="section-head">
      <h2 class="section-title">ðŸ”¥ Em tendÃªncia</h2>
      <div id="trendMeta" class="result-meta"></div>
    </div>
    <div id="trendGrid" class="grid"></div>
    <nav id="trendPagination" class="pagination" aria-label="PaginaÃ§Ã£o de tendÃªncias"></nav>
  </section>

  <!-- Resultados -->
  <section id="resultsSection" style="display:none">
    <div class="section-head">
      <h2 class="section-title">Resultados</h2>
      <div id="resultMeta" class="result-meta"></div>
    </div>
    <div id="results" class="grid"></div>
    <nav id="pagination" class="pagination" aria-label="PaginaÃ§Ã£o de resultados"></nav>
  </section>

  <div id="empty" class="empty" style="display:none">FaÃ§a uma busca para comeÃ§ar ðŸ“š</div>
  <div id="err" class="empty error" style="display:none"></div>
</main>

<footer class="wrap">Feito com <span style="color:var(--brand)">verde</span> ðŸŒ¿ | <a href="listas.html">Listas</a></footer>

<!-- Modal -->
<dialog id="bookModal">
  <div class="modal">
    <div class="cover"><img id="mCover" alt="Capa"/></div>
    <div>
      <h2 id="mTitle">&nbsp;</h2>
      <div class="sub" id="mAuthors"></div>
      <div class="sub" id="mMeta"></div>
      <div class="lists" id="mLists"></div>
      <div style="margin-top:10px">
        <div class="sub" style="margin-bottom:6px">Sua nota</div>
        <div class="rating" id="mRating"></div>
      </div>
    </div>
  </div>
  <div class="scroll">
    <div id="mCategories" class="badges"></div>
    <p id="mDesc" style="white-space:pre-wrap;line-height:1.5"></p>
  </div>
</dialog>

<script>
  // ====== Config ======
  const PAGE_SIZE = 24;
  const FULL_RENDER_LIMIT = 12; // mostra os nÃºmeros de pÃ¡gina

  // ====== Storage ======
  const LS_KEY = 'mbiblio_state_v1';
  const loadState = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || { books: {} }; } catch { return { books: {} }; } };
  const saveState = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
  const updateBookState = (id, patch) => { const s = loadState(); s.books[id] = { ...(s.books[id]||{}), ...patch }; saveState(s); };

  // ====== Elements ======
  const resultsSection = document.getElementById('resultsSection');
  const resultsEl = document.getElementById('results');
  const paginationEl = document.getElementById('pagination');
  const resultMetaEl = document.getElementById('resultMeta');

  const trendingSection = document.getElementById('trendingSection');
  const trendGrid = document.getElementById('trendGrid');
  const trendPaginationEl = document.getElementById('trendPagination');
  const trendMetaEl = document.getElementById('trendMeta');

  const emptyEl = document.getElementById('empty');
  const errEl = document.getElementById('err');
  const qEl = document.getElementById('q');
  const btn = document.getElementById('searchBtn');
  const randomBtn = document.getElementById('randomBtn');

  btn.addEventListener('click', () => search(qEl.value, 1));
  qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(qEl.value, 1); });
  randomBtn.addEventListener('click', randomPick);

  // ====== HTTP helpers (com fallback dev; backend jÃ¡ forÃ§a PT-BR) ======
  async function fetchBooks(params){
    const qs = new URLSearchParams(params);
    const apiUrl = `/api/books?${qs.toString()}`;
    try {
      const r = await fetch(apiUrl);
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || 'Erro API /api/books');
      return data;
    } catch (e) {
      // Fallback DEV: consulta pÃºblica sem key (para rodar localmente)
      const gb = new URLSearchParams({
        q: params.q,
        orderBy: params.orderBy || 'relevance',
        printType: 'books',
        startIndex: params.startIndex || '0',
        maxResults: params.maxResults || String(PAGE_SIZE),
        country: 'BR',
        langRestrict: 'pt'
      });
      const url = `https://www.googleapis.com/books/v1/volumes?${gb.toString()}`;
      const r2 = await fetch(url);
      if (!r2.ok) throw new Error('Falha no fallback Google Books');
      return r2.json();
    }
  }
  async function fetchBook(id){
    try {
      const r = await fetch(`/api/book?id=${id}`);
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || 'Erro API /api/book');
      return data;
    } catch {
      const url = `https://www.googleapis.com/books/v1/volumes/${id}?country=BR`;
      const r2 = await fetch(url);
      if (!r2.ok) throw new Error('Falha no fallback detalhes');
      return r2.json();
    }
  }

  // ====== Estado ======
  const state = { mode:'trending', query:'', page:1, total:0 };
  const trendState = { items:[], page:1, total:0 };

  // ====== TendÃªncias (com paginaÃ§Ã£o) ======
  async function loadTrending(){
    try {
      const queries = [ 'subject:ficÃ§Ã£o', 'subject:romance', 'subject:fantasia', 'subject:biografia', 'subject:hq', 'subject:horror' ];
      const promises = queries.map(q => fetchBooks({ q, orderBy: 'newest', maxResults: 20 }).catch(()=>({items:[]})));
      const arr = await Promise.all(promises);
      const map = new Map();
      arr.forEach(d => (d.items||[]).forEach(it => { if(!map.has(it.id)) map.set(it.id, it); }));
      trendState.items = (arr.length ? Array.from(map.values()) : []);
      trendState.total = trendState.items.length;
      renderTrendingPage(1);
    } catch (e) {
      console.error(e);
      trendingSection.style.display='none';
    }
  }
  function renderTrendingPage(page){
    trendState.page = page;
    trendGrid.innerHTML = '';
    if (!trendState.total){ trendingSection.style.display='none'; return; }
    trendingSection.style.display='';

    const startIndex = (page-1)*PAGE_SIZE;
    const slice = trendState.items.slice(startIndex, startIndex + PAGE_SIZE);
    slice.forEach(item => renderCard(item, trendGrid));
    trendMetaEl.textContent = `Mostrando ${startIndex+1}â€“${Math.min(trendState.total,startIndex+slice.length)} de ${trendState.total} em tendÃªncia.`;
    renderPagination(trendState.total, PAGE_SIZE, page, trendPaginationEl, renderTrendingPage);
  }

  // ====== Busca paginada ======
  async function search(query, page=1){
    resultsEl.innerHTML = '';
    paginationEl.innerHTML = '';
    resultMetaEl.textContent = '';
    errEl.style.display = 'none';
    emptyEl.style.display = 'none';

    state.query = (query||'').trim();
    state.page = page;
    state.mode = 'search';

    if(!state.query){
      resultsSection.style.display = 'none';
      renderTrendingPage(1);
      emptyEl.style.display = 'block';
      emptyEl.textContent = 'FaÃ§a uma busca para comeÃ§ar ðŸ“š';
      return;
    }

    trendingSection.style.display = 'none';
    resultsSection.style.display = '';

    try{
      const startIndex = (page-1) * PAGE_SIZE;
      const data = await fetchBooks({
        q: state.query, orderBy: 'relevance', startIndex, maxResults: PAGE_SIZE
      });

      const total = Number(data.totalItems || 0);
      state.total = total;

      const items = data.items || [];
      if(!items.length){
        resultsEl.innerHTML = '';
        resultMetaEl.textContent = 'Nenhum resultado.';
        renderPagination(0, PAGE_SIZE, 1, paginationEl, p => search(state.query, p));
        return;
      }

      items.forEach(item => renderCard(item, resultsEl));

      const start = startIndex + 1;
      const end = Math.min(total, startIndex + items.length);
      resultMetaEl.textContent = `Mostrando ${start}â€“${end} de ${total} resultado${total!==1?'s':''}.`;

      renderPagination(total, PAGE_SIZE, page, paginationEl, p => search(state.query, p));

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }catch(err){
      errEl.textContent = 'Erro ao buscar resultados. Verifique as rotas /api.';
      errEl.style.display = 'block';
      console.error(err);
    }
  }

  // ====== PaginaÃ§Ã£o genÃ©rica ======
  function renderPagination(total, size, page, container, goToPage){
    container.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(total / size));
    if (totalPages <= 1) { container.style.display='none'; return; }
    container.style.display='flex';
  
    const addBtn = (label, p, {disabled=false,current=false,aria='' }={})=>{
      const b = document.createElement('button');
      b.type='button';
      b.className = `page-btn${current?' current':''}`;
      b.textContent = label;
      if (aria) b.setAttribute('aria-label', aria);
      if (current) b.setAttribute('aria-current','page');
      b.disabled = disabled;
      if (!current && !disabled) b.addEventListener('click', ()=> goToPage(p));
      container.appendChild(b);
    };
    const addEllipsis = ()=>{
      const s=document.createElement('span');
      s.className='page-ellipsis';
      s.textContent='â€¦';
      container.appendChild(s);
    };
  
    // Anterior
    addBtn('â€¹ Anterior', Math.max(1,page-1), { disabled: page===1, aria:'PÃ¡gina anterior' });
  
    if (totalPages <= FULL_RENDER_LIMIT){
      // poucas pÃ¡ginas: mostra tudo
      for (let i=1;i<=totalPages;i++){
        addBtn(String(i), i, { current: i===page, aria:`Ir para pÃ¡gina ${i}` });
      }
    } else {
      // muitas pÃ¡ginas: usa reticÃªncias
      addBtn('1', 1, { current: page===1 });
  
      // reticÃªncias Ã  esquerda?
      if (page > 3) addEllipsis();
  
      // janela central (2 antes e 2 depois)
      const start = Math.max(2, page-2);
      const end   = Math.min(totalPages-1, page+2);
      for (let i=start;i<=end;i++){
        addBtn(String(i), i, { current: i===page });
      }
  
      // reticÃªncias Ã  direita?
      if (page < totalPages-2) addEllipsis();
  
      // Ãºltima pÃ¡gina
      addBtn(String(totalPages), totalPages, { current: page===totalPages });
    }
  
    // PrÃ³xima
    addBtn('PrÃ³xima â€º', Math.min(totalPages,page+1), { disabled: page===totalPages, aria:'PrÃ³xima pÃ¡gina' });
  }

  function randomPick(){
    const seeds = ['fantasia','romance','ficÃ§Ã£o cientÃ­fica','histÃ³ria','programaÃ§Ã£o','filosofia','poesia','biografia','terror'];
    const pick = seeds[Math.floor(Math.random()*seeds.length)];
    qEl.value = pick; search(pick, 1);
  }

  // ====== Cards & Modal ======
  function renderCard(item, container){
    const v = item.volumeInfo || {};
    const id = item.id;
    const thumb = v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || 'https://via.placeholder.com/300x450?text=Sem+Capa';
    const title = v.title || 'Sem tÃ­tulo';
    const authors = v.authors?.join(', ') || 'Autor desconhecido';
    const cats = v.categories?.slice(0,2) || [];

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="thumb"><img alt="${escapeHtml(title)}" src="${thumb}"></div>
      <div class="content">
        <h3 class="title">${escapeHtml(title)}</h3>
        <div class="meta">${escapeHtml(authors)}</div>
        <div class="badges">${cats.map(c=>`<span class='badge'>${escapeHtml(c)}</span>`).join('')}</div>
      </div>
      <div class="actions">
        <button class="btn small btn-ghost" data-open="${id}">Detalhes</button>
        <button class="btn small" data-fav="${id}">Favorito</button>
      </div>
    `;
    container.appendChild(card);
    card.querySelector('[data-open]')?.addEventListener('click', ()=> openModal(id));
    card.querySelector('[data-fav]')?.addEventListener('click', ()=> toggleList(id, 'favorito', item));
    card.querySelector('.thumb')?.addEventListener('click', ()=> openModal(id));
  }

  function escapeHtml(s){ return s?.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) || ''; }
  function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ''; }
  function labelList(k){ return ({favorito:'Favorito', lido:'Lido', queroLer:'Quero Ler'})[k] || k; }

  // Modal refs
  const dlg = document.getElementById('bookModal');
  const mCover = document.getElementById('mCover');
  const mTitle = document.getElementById('mTitle');
  const mAuthors = document.getElementById('mAuthors');
  const mMeta = document.getElementById('mMeta');
  const mDesc = document.getElementById('mDesc');
  const mCats = document.getElementById('mCategories');
  const mLists = document.getElementById('mLists');
  const mRating = document.getElementById('mRating');

  async function openModal(id){
    try{
      const data = await fetchBook(id);
      const v = data.volumeInfo || {};

      const cover = v.imageLinks?.thumbnail || v.imageLinks?.small || v.imageLinks?.smallThumbnail || '';
      mCover.src = cover || 'https://via.placeholder.com/300x450?text=Sem+Capa';
      mTitle.textContent = v.title || 'Sem tÃ­tulo';
      mAuthors.textContent = (v.authors?.join(', ') || 'Autor desconhecido');

      const publisher = v.publisher || 'Editora desconhecida';
      const pubDate = v.publishedDate || 'Data desconhecida';
      const pages = v.pageCount ? `${v.pageCount} pÃ¡ginas` : null;
      const rating = (v.averageRating ? `â˜… ${Number(v.averageRating).toFixed(1)}/5` : null);
      const lang = v.language ? v.language.toUpperCase() : null;
      const metaParts = [publisher, pubDate, pages, rating, lang].filter(Boolean);
      mMeta.textContent = metaParts.join(' â€¢ ');
      mCats.innerHTML = (v.categories||[]).map(c=>`<span class='badge'>${escapeHtml(c)}</span>`).join('');
      mDesc.textContent = v.description ? stripHtml(v.description) : 'Sem sinopse.';

      // Atualiza cache mÃ­nimo para Listas
      const st = loadState();
      const cur = st.books[id] || {};
      cur.title = v.title || cur.title;
      cur.authors = v.authors || cur.authors;
      cur.thumb = v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || cur.thumb;
      st.books[id] = cur; saveState(st);

      // BotÃµes de listas
      mLists.innerHTML = '';
      ['favorito','lido','queroLer'].forEach(list => {
        const b = document.createElement('button');
        b.className = 'chip-btn';
        b.textContent = labelList(list);
        const st2 = loadState().books[id];
        if(st2?.lists?.[list]) b.classList.add('active');
        b.addEventListener('click', ()=> toggleList(id, list, data, b));
        mLists.appendChild(b);
      });

      renderRatingControl(id);

      dlg.showModal();
      dlg.addEventListener('click', (e)=>{ if(e.target===dlg) dlg.close(); }, { once:true });
    }catch(err){
      alert('Erro ao carregar detalhes do livro.');
      console.error(err);
    }
  }

  function toggleList(id, list, itemData, btn){
    const st = loadState();
    const cur = st.books[id] || {};
    const curLists = cur.lists || {};
    const newVal = !curLists[list];
    curLists[list] = newVal;

    if(itemData){
      const v = itemData.volumeInfo || {};
      cur.title = v.title || cur.title;
      cur.authors = v.authors || cur.authors;
      cur.thumb = v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || cur.thumb;
    }
    st.books[id] = { ...cur, lists: curLists };
    saveState(st);
    if(btn) btn.classList.toggle('active', newVal);
  }

  function renderRatingControl(id){
    mRating.innerHTML = '';
    const st = loadState();
    const current = +(st.books[id]?.rating || 0);
    for(let i=10;i>=1;i--){
      const val = i*0.5;
      const span = document.createElement('span');
      span.className = 'star'+(current>=val?' filled':'');
      span.title = val.toFixed(1);
      span.addEventListener('click', ()=> setRating(id, val));
      mRating.appendChild(span);
    }
    const zero = document.createElement('button');
    zero.className='chip-btn'; zero.textContent='Zerar';
    zero.style.marginLeft='8px';
    zero.addEventListener('click', ()=> setRating(id, 0));
    mRating.appendChild(zero);
  }
  const setRating = (id, val) => { updateBookState(id, { rating: val }); renderRatingControl(id); };

  // ====== Init ======
  loadTrending(); // tendÃªncias com paginaÃ§Ã£o
</script>
</body>
</html>
