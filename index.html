<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minha Biblioteca</title>
  <style>
    :root{
      --bg:#0b1210;           /* fundo escuro esverdeado */
      --card:#101a17;         /* cards */
      --muted:#95b5a3;        /* texto secundÃ¡rio */
      --text:#e9f4ee;         /* texto principal */
      --brand:#36c077;        /* verde principal */
      --brand-2:#2aa866;      /* verde escuro */
      --brand-3:#1c7b4b;      /* hover */
      --chip:#183126;         /* tags */
      --border:#254236;       /* bordas */
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(120deg,#07100c,#0d1513 30%,#07100c);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}
    header{position:sticky;top:0;z-index:5;background:rgba(11,18,16,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.3px}
    .pill{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:999px}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:10px;background:var(--brand);color:#052313;font-weight:700;padding:10px 14px;box-shadow:var(--shadow);transition:transform .06s ease, filter .2s}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .search{display:grid;grid-template-columns:1fr auto auto;gap:10px;margin-top:14px}
    input[type="text"], select{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px;outline:none}
    input::placeholder{color:#a8c7b8}
    main{padding:22px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{aspect-ratio:3/4;background:#0e1915;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:12px}
    .title{font-size:15px;font-weight:700;line-height:1.2;margin:0 0 6px}
    .meta{font-size:13px;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .badge{font-size:11px;background:var(--chip);color:var(--muted);border:1px solid var(--border);padding:4px 6px;border-radius:999px}
    .actions{display:flex;gap:8px;margin-top:auto;padding:12px}
    .small{padding:7px 10px;font-size:13px;border-radius:8px}

    /* Modal */
    dialog{border:none;border-radius:16px;width:min(900px,96vw);background:linear-gradient(180deg,#0f1a17,#0a1412);color:var(--text);box-shadow:0 30px 80px rgba(0,0,0,.6);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
    .modal{display:grid;grid-template-columns:180px 1fr;gap:18px;padding:18px;border-bottom:1px solid var(--border)}
    .modal .cover{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#0e1915}
    .modal .cover img{width:100%;display:block}
    .modal h2{margin:0 0 6px;font-size:20px}
    .modal .sub{color:var(--muted);font-size:13px}
    .scroll{max-height:46vh;overflow:auto;padding:18px;border-top:1px solid var(--border)}

    .lists{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip-btn{border:1px solid var(--border);background:var(--chip);color:var(--muted);padding:8px 10px;border-radius:999px;cursor:pointer}
    .chip-btn.active{background:var(--brand);color:#052313;border-color:transparent}

    /* Rating (0â€“5 com 0.5) */
    .rating{display:inline-flex;flex-direction:row-reverse;gap:6px}
    .star{font-size:24px;cursor:pointer;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
    .star::before{content:"â˜†"}
    .star.filled::before{content:"â˜…";color:var(--brand)}

    .nav{display:flex;gap:10px;align-items:center}
    footer{border-top:1px solid var(--border);padding:18px;color:var(--muted)}

    .empty{opacity:.8;border:1px dashed var(--border);border-radius:14px;padding:20px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>Minha Biblioteca</h1>
      <span class="pill">Google Books</span>
      <div class="nav" style="margin-left:auto">
        <a class="btn btn-ghost" href="listas.html">Ver Listas</a>
        <button class="btn" id="randomBtn" title="Sinto-me com sorte">AleatÃ³rio</button>
      </div>
      <div class="search" style="width:100%">
        <input id="q" type="text" placeholder="Busque por tÃ­tulo, autor ou ISBN..." />
        <select id="filterLang" title="Idioma">
          <option value="">Todos idiomas</option>
          <option value="pt">PortuguÃªs</option>
          <option value="en">InglÃªs</option>
          <option value="es">Espanhol</option>
        </select>
        <button class="btn" id="searchBtn">Buscar</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="results" class="grid"></div>
    <div id="empty" class="empty" style="display:none">FaÃ§a uma busca para comeÃ§ar ðŸ“š</div>
  </main>

  <footer class="wrap">Feito com <span style="color:var(--brand)">verde</span> ðŸŒ¿ | <a href="listas.html">Listas</a></footer>

  <dialog id="bookModal">
    <div class="modal">
      <div class="cover"><img id="mCover" alt="Capa"/></div>
      <div>
        <h2 id="mTitle">&nbsp;</h2>
        <div class="sub" id="mAuthors"></div>
        <div class="sub" id="mMeta"></div>
        <div class="lists" id="mLists"></div>
        <div style="margin-top:10px">
          <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Sua nota</div>
          <div class="rating" id="mRating"></div>
        </div>
      </div>
    </div>
    <div class="scroll">
      <div id="mCategories" class="badges"></div>
      <p id="mDesc" style="white-space:pre-wrap;line-height:1.5"></p>
    </div>
  </dialog>

<script>
  // === Config ===

  // === Helpers de Storage ===
  const LS_KEY = 'mbiblio_state_v1';
  function loadState(){
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || { books: {} }; }
    catch(e){ return { books: {} }; }
  }
  function saveState(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function updateBookState(id, patch){
    const st = loadState();
    st.books[id] = { ...(st.books[id]||{}), ...patch };
    saveState(st);
  }

  // === Elementos ===
  const resultsEl = document.getElementById('results');
  const emptyEl = document.getElementById('empty');
  const qEl = document.getElementById('q');
  const btn = document.getElementById('searchBtn');
  const langEl = document.getElementById('filterLang');
  const randomBtn = document.getElementById('randomBtn');

  btn.addEventListener('click', () => search(qEl.value));
  qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(qEl.value); });
  randomBtn.addEventListener('click', randomPick);

  // === Busca (via backend /api/books) ===
  async function search(query){
    resultsEl.innerHTML = '';
    emptyEl.style.display = 'none';
    if(!query){ emptyEl.style.display='block'; return; }

    let url = `/api/books?q=${encodeURIComponent(query)}`;
    if(langEl.value) url += `&lang=${langEl.value}`;

    try{
      const res = await fetch(url);
      const data = await res.json();
      if(!data.items){ emptyEl.style.display='block'; return; }
      data.items.forEach(renderCard);
    }catch(err){
      emptyEl.textContent = 'Erro ao buscar resultados. Tente novamente.';
      emptyEl.style.display = 'block';
    }
  }

  async function randomPick(){
    const seeds = ['fantasia','romance','ficÃ§Ã£o cientÃ­fica','histÃ³ria','programaÃ§Ã£o','filosofia','poesia','biografia'];
    const pick = seeds[Math.floor(Math.random()*seeds.length)];
    qEl.value = pick; search(pick);
  }

  function renderCard(item){
    const v = item.volumeInfo || {};
    const id = item.id;
    const thumb = v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || 'https://via.placeholder.com/300x450?text=Sem+Capa';
    const title = v.title || 'Sem tÃ­tulo';
    const authors = v.authors?.join(', ') || 'Autor desconhecido';
    const cats = v.categories?.slice(0,3) || [];

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="thumb"><img alt="${escapeHtml(title)}" src="${thumb}"></div>
      <div class="content">
        <h3 class="title">${escapeHtml(title)}</h3>
        <div class="meta">${escapeHtml(authors)}</div>
        <div class="badges">${cats.map(c=>`<span class='badge'>${escapeHtml(c)}</span>`).join('')}</div>
      </div>
      <div class="actions">
        <button class="btn small btn-ghost" data-open="${id}">Detalhes</button>
        <button class="btn small" data-fav="${id}">Favorito</button>
      </div>
    `;
    resultsEl.appendChild(card);
    card.querySelector('[data-open]')?.addEventListener('click', ()=> openModal(id));
    card.querySelector('[data-fav]')?.addEventListener('click', ()=> toggleList(id, 'favorito', item));
    card.querySelector('.thumb')?.addEventListener('click', ()=> openModal(id));
  }

  function escapeHtml(s){ return s?.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) || ''; }

  // === Modal ===
  const dlg = document.getElementById('bookModal');
  const mCover = document.getElementById('mCover');
  const mTitle = document.getElementById('mTitle');
  const mAuthors = document.getElementById('mAuthors');
  const mMeta = document.getElementById('mMeta');
  const mDesc = document.getElementById('mDesc');
  const mCats = document.getElementById('mCategories');
  const mLists = document.getElementById('mLists');
  const mRating = document.getElementById('mRating');

  async function openModal(id){
    try{
      const data = await fetch(`/api/book?id=${id}`).then(r=>r.json());
      const v = data.volumeInfo || {};

      const cover = v.imageLinks?.thumbnail || v.imageLinks?.small || v.imageLinks?.smallThumbnail || '';
      mCover.src = cover || 'https://via.placeholder.com/300x450?text=Sem+Capa';
      mTitle.textContent = v.title || 'Sem tÃ­tulo';
      mAuthors.textContent = (v.authors?.join(', ') || 'Autor desconhecido');

      const publisher = v.publisher || 'Editora desconhecida';
      const pubDate = v.publishedDate || 'Data desconhecida';
      const pages = v.pageCount ? `${v.pageCount} pÃ¡ginas` : null;
      const rating = (v.averageRating ? `â˜… ${Number(v.averageRating).toFixed(1)}/5` : null);
      const lang = v.language ? v.language.toUpperCase() : null;
      const metaParts = [publisher, pubDate, pages, rating, lang].filter(Boolean);
      mMeta.textContent = metaParts.join(' â€¢ ');

      mCats.innerHTML = (v.categories||[]).map(c=>`<span class='badge'>${escapeHtml(c)}</span>`).join('');
      mDesc.textContent = v.description ? stripHtml(v.description) : 'Sem sinopse.';

      // botÃµes de listas
      mLists.innerHTML = '';
      ['favorito','lido','queroLer'].forEach(list => {
        const btn = document.createElement('button');
        btn.className = 'chip-btn';
        btn.textContent = labelList(list);
        const st = loadState().books[id];
        if(st?.lists?.[list]) btn.classList.add('active');
        btn.addEventListener('click', ()=> toggleList(id, list, data, btn));
        mLists.appendChild(btn);
      });

      // rating (0â€“5 step 0.5)
      renderRatingControl(id);

      dlg.showModal();
      dlg.addEventListener('click', (e)=>{ if(e.target===dlg) dlg.close(); }, { once:true });
    }catch(err){
      alert('Erro ao carregar detalhes do livro.');
    }
  }

  function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ''; }
  function labelList(k){ return {favorito:'Favorito', lido:'Lido', queroLer:'Quero Ler'}[k] || k; }

  function toggleList(id, list, itemData, btn){
    const st = loadState();
    const cur = st.books[id] || {};
    const curLists = cur.lists || {};
    const newVal = !curLists[list];
    curLists[list] = newVal;

    // guardamos info mÃ­nima para render rÃ¡pido nas listas
    if(itemData){
      const v = itemData.volumeInfo || {};
      cur.title = v.title || cur.title;
      cur.authors = v.authors || cur.authors;
      cur.thumb = v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || cur.thumb;
    }

    st.books[id] = { ...cur, lists: curLists };
    saveState(st);
    if(btn){ btn.classList.toggle('active', newVal); }
  }

  function renderRatingControl(id){
    mRating.innerHTML = '';
    const st = loadState();
    const current = +(st.books[id]?.rating || 0);
    // 10 marcadores (0.5)
    for(let i=10;i>=1;i--){
      const val = i*0.5;
      const span = document.createElement('span');
      span.className = 'star'+(current>=val?' filled':'');
      span.title = val.toFixed(1);
      span.addEventListener('click', ()=> setRating(id, val));
      mRating.appendChild(span);
    }
    // zero
    const zero = document.createElement('button');
    zero.className='chip-btn'; zero.textContent='Zerar';
    zero.style.marginLeft='8px';
    zero.addEventListener('click', ()=> setRating(id, 0));
    mRating.appendChild(zero);
  }
  function setRating(id, val){ updateBookState(id, { rating: val }); renderRatingControl(id); }

</script>
</body>
</html>
